# ビジネス言語化トレーナー 完全版要件定義書 v4.0

**プロジェクト名**: Business Communication Trainer  
**開発期間**: 3週間（21日間）  
**開発者**: 初心者レベル  
**目的**: インターン用ポートフォリオ作成  
**作成日**: 2025年10月13日  
**バージョン**: 4.0（実装ベース改訂版）  
**改訂理由**: Day 1-8の実装経験を反映、アーキテクチャの最適化

---

## 📋 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [技術スタック](#2-技術スタック)
3. [機能要件](#3-機能要件)
4. [データ構造](#4-データ構造)
5. [画面設計](#5-画面設計)
6. [API仕様](#6-api仕様)
7. [セキュリティ要件](#7-セキュリティ要件)
8. [非機能要件](#8-非機能要件)
9. [Week 2詳細スケジュール](#9-week-2詳細スケジュール)
10. [開発ガイドライン](#10-開発ガイドライン)

---

## 1. プロジェクト概要

### 1.1 目的
ビジネスパーソンが会議やプレゼンでの発言力を練習できるモバイルアプリケーション。Firebase Cloud FunctionsとOpenAI APIを活用して、セキュアで動的な質問生成とフィードバックを提供。

### 1.2 コアバリュー
- **動的AI質問生成**: ユーザーの回答に基づいて**3問**の追加質問を自動生成
- **音声入力＋文字起こし**: 実際の会議を想定した音声入力と自動テキスト化
- **建設的フィードバック**: AIコーチによる具体的な改善提案
- **履歴管理**: 過去の練習を振り返り成長を追跡
- **セキュアなアーキテクチャ**: APIキーはサーバーサイドで管理

### 1.3 ターゲットユーザー
- ビジネスパーソン（20-40代）
- 会議での発言に苦手意識がある人
- プレゼンスキルを向上させたい人

### 1.4 主要な設計変更（v3.0 → v4.0）

| 項目 | v3.0（旧） | v4.0（新） | 理由 |
|------|-----------|-----------|------|
| ゲストモード | あり | **完全廃止** | データ整合性向上、実装簡素化 |
| AI質問数 | 3-5問（可変） | **3問固定** | UX予測性向上、プログレスバー正確化 |
| OpenAIモデル | gpt-4/gpt-3.5 | **gpt-4o-mini** | コスト最適化、速度向上 |
| APIキー管理 | クライアント | **Cloud Functions** | セキュリティ強化 |
| 音声機能 | 録音のみ | **録音＋文字起こし** | UX向上、実用性強化 |

---

## 2. 技術スタック

### 2.1 フロントエンド
```javascript
{
  "core": {
    "framework": "React Native",
    "runtime": "Expo SDK 51+",
    "language": "JavaScript (ES6+)"
  },
  "navigation": {
    "library": "@react-navigation/native@^6.0",
    "navigators": ["Stack", "Tab"]
  },
  "stateManagement": {
    "global": "React Context API",
    "local": "useState, useReducer"
  },
  "ui": {
    "styling": "StyleSheet, Flexbox",
    "icons": "@expo/vector-icons",
    "animations": "Animated API"
  },
  "audio": {
    "recording": "expo-av@^14.0",
    "speechRecognition": "Expo Speech (将来対応)"
  }
}
```

### 2.2 バックエンド・サービス
```javascript
{
  "authentication": "Firebase Authentication@^10.0",
  "database": "Firebase Firestore@^10.0",
  "functions": "Firebase Cloud Functions (Node.js 18)",
  "ai": {
    "model": "gpt-4o-mini",
    "provider": "OpenAI API",
    "deployment": "Firebase Functions (asia-northeast1)"
  },
  "speechToText": {
    "primary": "Expo Speech Recognition",
    "fallback": "OpenAI Whisper API (Cloud Functions経由)"
  },
  "localCache": "@react-native-async-storage/async-storage"
}
```

### 2.3 開発ツール
- **Git/GitHub**: バージョン管理
- **Expo CLI**: 開発・ビルド
- **Expo Go**: 実機テスト
- **VS Code**: エディタ
- **Firebase CLI**: Functions デプロイ

### 2.4 アーキテクチャ図

```
┌─────────────────────────────────────────┐
│     React Native App (Expo)             │
│  ┌─────────────────────────────────┐   │
│  │  Screens & Components           │   │
│  └─────────────┬───────────────────┘   │
│                │                         │
│  ┌─────────────▼───────────────────┐   │
│  │  Context API (State Management) │   │
│  └─────────────┬───────────────────┘   │
│                │                         │
│  ┌─────────────▼───────────────────┐   │
│  │  Services Layer                 │   │
│  │  - authService                  │   │
│  │  - openaiService                │   │
│  │  - firestoreService             │   │
│  │  - speechService (新規)         │   │
│  └─────────────┬───────────────────┘   │
└────────────────┼───────────────────────┘
                 │
    ┌────────────┼────────────┐
    │            │            │
    ▼            ▼            ▼
┌─────────┐ ┌─────────┐ ┌─────────────┐
│Firebase │ │Firebase │ │Firebase     │
│  Auth   │ │Firestore│ │Cloud        │
│         │ │         │ │Functions    │
└─────────┘ └─────────┘ └──────┬──────┘
                               │
                    ┌──────────┼──────────┐
                    │          │          │
                    ▼          ▼          ▼
              ┌─────────┐ ┌─────────┐ ┌─────────┐
              │OpenAI   │ │Whisper  │ │その他   │
              │gpt-4o   │ │API      │ │API      │
              │-mini    │ │(将来)   │ │         │
              └─────────┘ └─────────┘ └─────────┘
```

---

## 3. 機能要件

### 3.1 ユーザー認証

#### 3.1.1 サインアップ
**機能**: メールアドレスとパスワードで新規登録

**要件**:
- メールアドレスのバリデーション（正規表現）
- パスワード強度チェック（8文字以上、英数字含む）
- 重複メールアドレスのエラーハンドリング
- 登録成功後、自動ログイン
- Firestoreにユーザープロファイル自動作成

**UI要素**:
- メールアドレス入力フィールド
- パスワード入力フィールド（マスク表示）
- パスワード確認フィールド
- 「登録」ボタン
- 「既にアカウントをお持ちの方」リンク

**実装状況**: ✅ 完了（Day 2-3）

#### 3.1.2 ログイン
**機能**: 既存アカウントでログイン

**要件**:
- メールアドレス・パスワード認証
- 認証エラーの適切な表示
- 「パスワードを忘れた」機能（将来対応）
- ログイン状態の永続化（Firebase Auth）
- 自動ログイン（トークン有効期限内）

**UI要素**:
- メールアドレス入力フィールド
- パスワード入力フィールド
- 「ログイン」ボタン
- 「新規登録はこちら」リンク

**実装状況**: ✅ 完了（Day 2-3）

#### 3.1.3 ログアウト
**機能**: セッション終了

**要件**:
- Firebase Authセッション終了
- ローカルキャッシュクリア
- ログイン画面へリダイレクト

**実装状況**: ✅ 完了（Day 3）

#### 3.1.4 ゲストモード
**ステータス**: ⛔ **完全廃止**

**理由**:
- データ整合性の向上
- 実装の簡素化
- セキュリティの強化
- Cloud Functions認証必須

**廃止作業**: Day 9実施予定

---

### 3.2 場面選択機能

#### 3.2.1 提供する4つのシーン

**1. 週次報告会議**
- ID: `weekly-report`
- 固定質問: 「今週の進捗状況と、現在直面している課題を具体的に説明してください」
- アイコン: 📊
- 説明: 上司や同僚に進捗を報告する場面
- AI質問数: **3問固定**

**2. プロジェクト提案**
- ID: `project-proposal`
- 固定質問: 「提案するプロジェクトの目的と、なぜ今これが必要なのかを説明してください」
- アイコン: 💡
- 説明: 新規プロジェクトを提案する場面
- AI質問数: **3問固定**

**3. 問題解決の議論**
- ID: `problem-solving`
- 固定質問: 「直面している問題の具体的な状況と、それが引き起こしている影響を説明してください」
- アイコン: 🔧
- 説明: チームで課題を議論する場面
- AI質問数: **3問固定**

**4. 顧客へのプレゼン**
- ID: `customer-presentation`
- 固定質問: 「提案する商品/サービスと、それがお客様のどんな課題を解決するかを説明してください」
- アイコン: 🎯
- 説明: 顧客に提案する場面
- AI質問数: **3問固定**

#### 3.2.2 UI要件
- 4つのカードを縦スクロール表示
- 各カード: アイコン + 場面名 + 説明 + 「練習開始」ボタン
- カードタップで練習画面へ遷移
- タブレット: 2列グリッド表示（将来対応）

**実装状況**: ✅ 完了（Day 5）

---

### 3.3 練習セッション機能

#### 3.3.1 セッションフロー

```
[開始]
  ↓
[固定質問表示]
  ↓
[音声入力 → 録音]
  ↓
[音声 → テキスト変換] ← 新規実装（Day 9-10）
  ↓
[テキスト編集可能]
  ↓
[AI追加質問生成（3問固定）] ← Cloud Functions経由
  ↓
[追加質問1 → 回答]
  ↓
[追加質問2 → 回答]
  ↓
[追加質問3 → 回答]
  ↓
[AIフィードバック生成] ← Cloud Functions経由
  ↓
[フィードバック表示]
  ↓
[保存 or 再練習 or 終了]
```

#### 3.3.2 音声入力＋文字起こし機能 ⭐ 新規強化

**Phase 1: 音声録音（実装済み）**
- ✅ expo-av使用
- ✅ マイク権限のリクエスト
- ✅ 録音開始/停止
- ✅ 録音中のパルスアニメーション
- ✅ 経過時間表示

**Phase 2: 文字起こし（Day 9-10実装）** 🆕
```javascript
// 実装方針
{
  "primary": {
    "method": "Expo Speech Recognition",
    "pros": "ネイティブ、無料、高速",
    "cons": "プラットフォーム依存"
  },
  "fallback": {
    "method": "Whisper API (Cloud Functions経由)",
    "pros": "高精度、プラットフォーム非依存",
    "cons": "コスト、レイテンシ"
  }
}
```

**実装詳細**:
1. **録音完了時**: 音声ファイルを取得
2. **文字起こし**: Expo Speech or Whisper API
3. **テキスト表示**: 編集可能なTextInput
4. **エラーハンドリング**: フォールバック機能

**UI要件**:
- 録音ボタン（タップホールド）
- 録音中の視覚的フィードバック
  - パルスアニメーション ✅
  - 経過時間表示 ✅
  - 音量レベルインジケーター（将来対応）
- テキスト編集フィールド
- 「文字起こし中...」ローディング表示
- キーボード入力のフォールバック

**エラーハンドリング**:
- マイク権限拒否時の案内 ✅
- 音声認識失敗時のリトライ
- ネットワークエラー時のキーボード入力
- タイムアウト処理（30秒）

**実装状況**: 
- 録音機能: ✅ 完了（Day 6）
- 文字起こし: ⏳ Day 9-10実装予定

#### 3.3.3 AI質問生成（実装済み） ✅

**仕様変更**: 3-5問（可変） → **3問固定**

**理由**:
- ユーザー体験の予測可能性向上
- プログレスバーの正確な表示（1/4 → 2/4 → 3/4 → 4/4）
- 実装の簡素化
- セッション時間の最適化（5-10分）

**アーキテクチャ**: Firebase Cloud Functions経由

**入力**:
- 場面ID（sceneId）
- 場面名（sceneName）
- AIプロンプト（aiPrompt）
- ユーザーの初回回答（userAnswer）

**処理フロー**:
1. クライアント → Firebase Functions呼び出し
2. Functions → OpenAI API呼び出し（gpt-4o-mini）
3. JSON形式でレスポンス受信
4. 質問リスト（**3問固定**）を返却
5. エラー時 → デフォルト質問（3問）を使用

**レスポンス例**:
```json
{
  "questions": [
    "そのAPIエラーの具体的な原因は特定できていますか？",
    "3日の遅延は、全体のリリーススケジュールにどう影響しますか？",
    "API提供元には問い合わせていますか？対応状況は？"
  ],
  "totalQuestions": 3,
  "source": "AI",
  "reasoning": "報告が具体的だったため3問に絞りました"
}
```

**エラーハンドリング**:
- API呼び出し失敗時: デフォルト質問を使用 ✅
- レート制限エラー: ユーザーに通知
- タイムアウト: 35秒で中断 ✅
- 認証エラー: ログインを促す ✅

**実装状況**: ✅ 完了（Day 8）

#### 3.3.4 進捗表示

**要素**:
- 現在の質問番号 / 総質問数（例: **1/4, 2/4, 3/4, 4/4**）
- プログレスバー（25% → 50% → 75% → 100%）
- 質問文の表示
- 回答テキストの表示
- 「次へ」ボタン（回答入力後に有効化）
  - 最小文字数: 10文字
  - 最大文字数: 2000文字
  - リアルタイム文字数カウンター
- 「セッション終了」ボタン（確認ダイアログ表示）

**実装状況**: ✅ 完了（Day 7）

---

### 3.4 フィードバック機能

#### 3.4.1 AIフィードバック生成（Day 9-10実装予定）

**アーキテクチャ**: Firebase Cloud Functions経由 🆕

**入力**:
- 場面ID（sceneId）
- 場面名（sceneName）
- 全Q&A履歴（質問と回答のペア配列）

**処理フロー**:
1. クライアント → Firebase Functions呼び出し
2. Functions → OpenAI API呼び出し（gpt-4o-mini）
3. フィードバック生成プロンプト使用
4. JSON形式でレスポンス受信

**レスポンス構造**:
```json
{
  "summary": "全体的な印象を1-2文で",
  "goodPoints": [
    {
      "aspect": "具体性",
      "quote": "ECサイトの決済機能を実装中",
      "comment": "プロジェクト名を明確に示していて良い"
    }
  ],
  "improvementPoints": [
    {
      "aspect": "論理構造",
      "original": "遅延しています",
      "improved": "予定より3日遅延していますが、全体スケジュールへの影響は最小限です",
      "reason": "影響範囲まで伝えると安心感を与えられます"
    }
  ],
  "encouragement": "励ましの言葉"
}
```

**エラーハンドリング**:
- API呼び出し失敗時: 汎用フィードバックを使用
- タイムアウト: 45秒で中断
- 認証エラー: ログインを促す

**実装状況**: ⏳ Day 9-10実装予定

#### 3.4.2 フィードバック表示（Day 10-11実装予定）

**UI構成**:
1. **ヘッダー**: 「お疲れ様でした！」
2. **サマリー**: 全体的な印象
3. **良かった点セクション**:
   - 見出し: ✅ 良かった点
   - 各ポイントをカード表示
   - 引用部分をハイライト
4. **改善点セクション**:
   - 見出し: 💡 改善のヒント
   - Before/After比較表示
   - 改善の効果説明
5. **励ましメッセージ**
6. **アクションボタン**:
   - 「履歴に保存」
   - 「もう一度練習」
   - 「別の場面を選ぶ」

**実装状況**: ⏳ Day 10-11実装予定

---

### 3.5 履歴機能（Day 12-14実装予定）

#### 3.5.1 セッション保存

**保存タイミング**:
- フィードバック表示後、「履歴に保存」ボタンをタップ
- 自動保存（デフォルトON）

**保存データ**:
```javascript
{
  sessionId: "uuid",
  userId: "firebaseUserId",
  sceneId: "weekly-report",
  sceneName: "週次報告会議",
  timestamp: timestamp,
  qaList: [
    {
      questionId: "q1",
      questionText: "固定質問の内容",
      answerText: "ユーザーの回答",
      answerDuration: 45, // 秒
      isFixedQuestion: true
    },
    // AI質問3問
  ],
  totalQuestions: 4, // 固定1 + AI3
  feedback: {
    summary: "...",
    goodPoints: [...],
    improvementPoints: [...]
  },
  duration: 480, // セッション全体の秒数
  createdAt: timestamp,
  updatedAt: timestamp
}
```

#### 3.5.2 履歴一覧画面（必須機能のみ）

**表示内容**:
- セッションカード（最新順）
  - 場面名 + アイコン
  - 日時（相対表示: 2時間前、3日前）
  - 質問数（常に4問）
  - タップで詳細表示
- 空状態: 「まだ練習履歴がありません」
- Pull to Refresh
- ページネーション（10件ずつロード）

**スコープ外（将来対応）**:
- ❌ フィルター機能（場面別、日付別）
- ❌ 統計情報
- ❌ エクスポート機能

#### 3.5.3 履歴詳細画面（必須機能のみ）

**表示内容**:
- セッション情報
  - 日時
  - 場面名
  - 所要時間
- Q&A履歴（展開表示）
- フィードバック全文
- アクション
  - **削除ボタン**（確認ダイアログ）

**スコープ外（将来対応）**:
- ❌ 共有機能
- ❌ 編集機能

**実装状況**: ⏳ Day 12-14実装予定

---

### 3.6 プロフィール画面

**表示情報**:
- ユーザー名（編集可能）
- メールアドレス
- 登録日

**アクション**:
- ログアウトボタン

**スコープ外（将来対応）**:
- ❌ 統計情報（総練習回数など）
- ❌ アカウント削除
- ❌ 設定画面

**実装状況**: ✅ 基本実装完了（Day 3）

---

## 4. データ構造

### 4.1 Firestore コレクション

#### users コレクション
```javascript
{
  userId: "firebaseAuthUid",
  email: "user@example.com",
  displayName: "山田太郎",
  createdAt: timestamp,
  lastLoginAt: timestamp,
  settings: {
    autoSave: true, // デフォルトtrue
    notifications: false
  }
}
```

#### sessions コレクション
```javascript
{
  sessionId: "uuid",
  userId: "firebaseAuthUid",
  sceneId: "weekly-report",
  sceneName: "週次報告会議",
  timestamp: timestamp,
  qaList: [
    {
      questionId: "q1",
      questionText: "質問内容",
      answerText: "回答内容",
      answerDuration: 45,
      isFixedQuestion: true
    }
    // AI質問3問（isFixedQuestion: false）
  ],
  totalQuestions: 4, // 固定1 + AI3
  feedback: {
    summary: "総評",
    goodPoints: [
      {
        aspect: "具体性",
        quote: "引用テキスト",
        comment: "コメント"
      }
    ],
    improvementPoints: [
      {
        aspect: "論理構造",
        original: "改善前",
        improved: "改善後",
        reason: "理由"
      }
    ],
    encouragement: "励ましの言葉"
  },
  duration: 480,
  createdAt: timestamp,
  updatedAt: timestamp
}
```

### 4.2 AsyncStorage（ローカル）

**キー構造**:
```javascript
{
  "@user_token": "firebaseIdToken",
  "@last_session": "sessionDataJSON", // オフライン対応
  "@app_settings": "settingsJSON"
}
```

**削除**: `@guest_sessions`（ゲストモード廃止に伴い削除）

---

## 5. 画面設計

### 5.1 画面一覧

1. **認証関連**
   - LoginScreen ✅
   - SignupScreen ✅

2. **メイン機能**
   - HomeScreen（タブ: ホーム） ✅
   - SceneSelectionScreen ✅
   - PracticeScreen ✅
   - FeedbackScreen ⏳

3. **履歴機能**
   - HistoryScreen（タブ: 履歴） ⏳
   - SessionDetailScreen ⏳

4. **その他**
   - ProfileScreen（タブ: プロフィール） ✅

### 5.2 ナビゲーション構造

```
AuthNavigator (Stack)
  - LoginScreen
  - SignupScreen

MainNavigator (Tab)
  - HomeTab (Stack)
    - HomeScreen
    - SceneSelectionScreen
    - PracticeScreen
    - FeedbackScreen
  - HistoryTab (Stack)
    - HistoryScreen
    - SessionDetailScreen
  - ProfileTab
    - ProfileScreen
```

**変更点**: ゲストモード関連のナビゲーション削除

### 5.3 画面遷移図

```
[LoginScreen]
    ↓ ログイン成功
[HomeScreen (Tab1)]
    ↓ 「練習を始める」
[SceneSelectionScreen]
    ↓ 場面選択
[PracticeScreen]
    ↓ 全質問完了
[FeedbackScreen]
    ↓ 「履歴を見る」
[HistoryScreen (Tab2)]
    ↓ セッション選択
[SessionDetailScreen]

[ProfileScreen (Tab3)]
```

---

## 6. API仕様

### 6.1 Firebase Cloud Functions

#### 6.1.1 generateQuestions ✅ 実装済み

**エンドポイント**: `https://asia-northeast1-{project-id}.cloudfunctions.net/generateQuestions`

**リクエスト**:
```javascript
{
  sceneId: "weekly-report",
  sceneName: "週次報告会議",
  aiPrompt: "システムプロンプト",
  userAnswer: "ユーザーの回答"
}
```

**レスポンス**:
```javascript
{
  questions: ["質問1", "質問2", "質問3"], // 3問固定
  totalQuestions: 3,
  source: "AI" | "DEFAULT",
  reasoning: "生成理由"
}
```

**エラーレスポンス**:
```javascript
{
  code: "unauthenticated" | "invalid-argument" | "internal",
  message: "エラーメッセージ"
}
```

**実装状況**: ✅ Day 8完了

---

#### 6.1.2 generateFeedback ⏳ Day 9実装予定

**エンドポイント**: `https://asia-northeast1-{project-id}.cloudfunctions.net/generateFeedback`

**リクエスト**:
```javascript
{
  sceneId: "weekly-report",
  sceneName: "週次報告会議",
  qaList: [
    {
      questionText: "質問",
      answerText: "回答"
    }
  ]
}
```

**レスポンス**:
```javascript
{
  summary: "総評",
  goodPoints: [
    {
      aspect: "具体性",
      quote: "引用",
      comment: "コメント"
    }
  ],
  improvementPoints: [
    {
      aspect: "論理構造",
      original: "改善前",
      improved: "改善後",
      reason: "理由"
    }
  ],
  encouragement: "励まし",
  source: "AI" | "DEFAULT"
}
```

**実装予定**: Day 9

---

#### 6.1.3 transcribeAudio ⏳ Day 9-10実装予定

**エンドポイント**: `https://asia-northeast1-{project-id}.cloudfunctions.net/transcribeAudio`

**リクエスト**:
```javascript
{
  audioData: "base64EncodedAudio",
  format: "m4a" | "wav",
  language: "ja"
}
```

**レスポンス**:
```javascript
{
  text: "文字起こしテキスト",
  confidence: 0.95,
  duration: 30.5
}
```

**実装方針**:
- Whisper API使用（gpt-4o-miniより高精度）
- 最大ファイルサイズ: 25MB
- タイムアウト: 60秒

**実装予定**: Day 9-10（Expo Speech Recognition失敗時のフォールバック）

---

### 6.2 OpenAI API（Cloud Functions経由）

**直接呼び出しなし**: すべてCloud Functions経由

**使用モデル**: **gpt-4o-mini**

**理由**:
- コスト効率: gpt-4の約1/15
- 速度: レスポンス2-3秒
- 品質: 質問生成・フィードバックには十分

---

### 6.3 Firebase Authentication API

**サインアップ**:
```javascript
import { createUserWithEmailAndPassword } from 'firebase/auth';

await createUserWithEmailAndPassword(auth, email, password);
```

**ログイン**:
```javascript
import { signInWithEmailAndPassword } from 'firebase/auth';

await signInWithEmailAndPassword(auth, email, password);
```

**ログアウト**:
```javascript
import { signOut } from 'firebase/auth';

await signOut(auth);
```

**実装状況**: ✅ Day 2-3完了

---

### 6.4 Firestore API

**セッション保存**:
```javascript
import { collection, addDoc, serverTimestamp } from 'firebase/firestore';

await addDoc(collection(db, 'sessions'), {
  ...sessionData,
  createdAt: serverTimestamp()
});
```

**セッション一覧取得**:
```javascript
import { collection, query, where, orderBy, limit, getDocs } from 'firebase/firestore';

const q = query(
  collection(db, 'sessions'),
  where('userId', '==', currentUserId),
  orderBy('timestamp', 'desc'),
  limit(10)
);
const snapshot = await getDocs(q);
```

**実装予定**: Day 12-13

---

## 7. セキュリティ要件

### 7.1 Firebase セキュリティルール

**Firestore Rules**:
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 認証必須（ゲストモード廃止）
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // 自分のデータのみアクセス可能
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // users コレクション
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // sessions コレクション
    match /sessions/{sessionId} {
      allow read, delete: if isAuthenticated() && 
                             resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && 
                      request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && 
                      resource.data.userId == request.auth.uid;
    }
  }
}
```

**変更点**: ゲストモードアクセス削除

---

### 7.2 Cloud Functions セキュリティ

**認証チェック**:
```javascript
exports.generateQuestions = functions
  .region('asia-northeast1')
  .https.onCall(async (data, context) => {
    // 認証必須
    if (!context.auth) {
      throw new functions.https.HttpsError(
        'unauthenticated',
        'この機能を使用するにはログインが必要です'
      );
    }
    
    // 処理...
  });
```

**APIキー管理**:
```bash
# Functions環境変数設定
firebase functions:config:set openai.key="YOUR_API_KEY"
```

**実装状況**: ✅ Day 8完了

---

### 7.3 API キー管理

**ベストプラクティス**:
- ✅ クライアント側にAPIキーを保存しない
- ✅ Cloud Functionsで一元管理
- ✅ `.env`をGitignoreに追加
- ✅ 本番環境はFirebase Functions Config使用

**環境変数**（開発用）:
```javascript
// .env（ローカル開発のみ）
FIREBASE_API_KEY=...
FIREBASE_AUTH_DOMAIN=...
FIREBASE_PROJECT_ID=...
```

---

### 7.4 データ保護

- ✅ パスワードはFirebase Authが自動でハッシュ化
- ✅ 音声データは一時的な処理のみ（保存しない）
- ✅ セッションデータは所有者のみアクセス可能
- ✅ HTTPS通信の強制
- ✅ Firebase App Checkの導入（将来対応）

---

## 8. 非機能要件

### 8.1 パフォーマンス

**目標値**:
- 画面遷移: 200ms以内
- AI質問生成: **5秒以内** ✅ 達成（gpt-4o-mini使用）
- AIフィードバック生成: **10秒以内**
- 音声認識レスポンス: 2秒以内
- 文字起こし: **30秒以内**
- 履歴一覧読み込み: 1秒以内

**最適化手法**:
- gpt-4o-mini使用（速度・コスト最適化）
- asia-northeast1リージョン使用（レイテンシ削減）
- Firestore インデックス最適化
- 画像の遅延読み込み
- リストのページネーション

---

### 8.2 ユーザビリティ

**アクセシビリティ**:
- 文字サイズ: 最小14pt
- コントラスト比: WCAG AA基準準拠
- タッチターゲット: 最小44x44pt
- エラーメッセージの明確化

**レスポンシブデザイン**:
- スマートフォン（縦向き）: 375px〜
- タブレット: 768px〜（将来対応）

---

### 8.3 互換性

**対応OS**:
- iOS: 13.0以上
- Android: 6.0 (API level 23)以上

---

### 8.4 可用性

**オフライン対応**（将来対応）:
- ローカルキャッシュによる基本画面表示
- オフライン時の適切なエラー表示
- オンライン復帰時の自動同期

**エラーリカバリ**:
- ✅ ネットワークエラー時のリトライ（最大3回）
- ✅ API失敗時のフォールバック質問
- ✅ タイムアウト処理（35秒）
- セッションデータの自動保存（将来対応）

---

## 9. Week 2詳細スケジュール

### **Day 9: ゲストモード廃止 + AIフィードバックAPI** ⏳

#### 午前（2-3時間）
- [ ] ゲストモード完全廃止
  - AuthContextからゲスト関連コード削除
  - LoginScreen/SignupScreenからゲストボタン削除
  - ナビゲーションの簡素化
  - テスト: 認証必須の確認

#### 午後（2-3時間）
- [ ] Cloud Functions: `generateFeedback`実装
  - フィードバック生成プロンプト作成
  - OpenAI API呼び出し
  - JSON レスポンス処理
  - エラーハンドリング
  - デプロイ＆テスト

**完了基準**:
- ✅ ゲストモード完全削除
- ✅ generateFeedback API動作確認
- ✅ フィードバック生成成功

---

### **Day 10: 文字起こし機能実装** ⏳

#### 午前（2-3時間）
- [ ] Expo Speech Recognition調査
  - ドキュメント確認
  - 実機テスト
  - 精度確認

#### 午後（2-3時間）
- [ ] 文字起こし実装
  - **Primary**: Expo Speech Recognition
  - **Fallback**: Whisper API（Cloud Functions）
  - VoiceRecorderコンポーネント更新
  - テキスト編集機能統合
  - エラーハンドリング

**完了基準**:
- ✅ 音声→テキスト変換が動作
- ✅ テキスト編集可能
- ✅ フォールバック機能動作

---

### **Day 11: フィードバック画面実装** ⏳

#### 午前（2-3時間）
- [ ] FeedbackScreen UI実装
  - ヘッダー
  - サマリー表示
  - 良かった点カード
  - 改善点カード（Before/After）
  - 励ましメッセージ

#### 午後（2-3時間）
- [ ] アクションボタン実装
  - 「履歴に保存」ボタン
  - 「もう一度練習」ボタン
  - 「別の場面を選ぶ」ボタン
  - スクロール対応

**完了基準**:
- ✅ フィードバックが見やすく表示
- ✅ すべてのボタンが動作
- ✅ エンドツーエンドで動作

---

### **Day 12: Firestoreデータモデル** ⏳

#### 午前（2-3時間）
- [ ] firestoreService.js作成
  - セッション保存関数
  - セッション取得関数
  - セッション削除関数
  - エラーハンドリング

#### 午後（2-3時間）
- [ ] Firestoreセキュリティルール設定
  - users コレクション
  - sessions コレクション
  - テスト

**完了基準**:
- ✅ Firestoreにデータ保存成功
- ✅ データ取得成功
- ✅ セキュリティルール正常動作

---

### **Day 13: データ保存機能** ⏳

#### 午前（2-3時間）
- [ ] セッション完了時の自動保存
  - FeedbackScreenに統合
  - 保存成功/失敗の通知
  - ローディング表示

#### 午後（2-3時間）
- [ ] エラーハンドリング
  - ネットワークエラー
  - 権限エラー
  - オフライン対応（基本）

**完了基準**:
- ✅ セッションが自動保存される
- ✅ 保存成功の通知表示
- ✅ エラー時の適切な処理

---

### **Day 14: 履歴機能** ⏳

#### 午前（2-3時間）
- [ ] HistoryScreen UI実装
  - セッション一覧表示
  - セッションカードデザイン
  - 空状態表示
  - Pull to Refresh

#### 午後（2-3時間）
- [ ] SessionDetailScreen実装
  - Q&A表示
  - フィードバック再表示
  - 削除ボタン
  - 削除確認ダイアログ

**完了基準**:
- ✅ 履歴一覧が表示される
- ✅ 詳細画面が表示される
- ✅ 削除が動作する

---

## 🎯 Week 2チェックポイント（Day 14終了時）

### ✅ 完了すべき項目
- [ ] ゲストモード完全廃止
- [x] AI質問生成が動作（Day 8で完了）
- [ ] AIフィードバック生成が動作
- [ ] 文字起こし機能が動作
- [ ] データ保存が動作
- [ ] 履歴機能が動作
- [ ] エンドツーエンドで全機能が動作

---

## 10. 開発ガイドライン

### 10.1 コーディング規約

**命名規則**:
- コンポーネント: PascalCase (例: `PracticeScreen`)
- 関数/変数: camelCase (例: `handleSubmit`)
- 定数: UPPER_SNAKE_CASE (例: `DEFAULT_QUESTIONS`)
- ファイル名: コンポーネントと同名

**フォルダ構造**:
```
/src
  /screens
  /components
    - VoiceRecorder.js ✅
  /contexts
    - AuthContext.js ✅
    - SessionContext.js ✅
  /services
    - authService.js ✅
    - firebaseConfig.js ✅
    - openaiService.js ✅
    - firestoreService.js ⏳
    - speechService.js ⏳ 新規
  /constants
    - scenes.js ✅
    - defaultQuestions.js ✅
  /utils
  /navigation
    - AppNavigator.js ✅
  /assets
```

---

### 10.2 Git運用

**コミットメッセージ**:
```
[種別] 簡潔な説明

詳細説明（任意）

例:
[feat] 文字起こし機能実装
[feat] Cloud Functions: generateFeedback実装
[refactor] ゲストモード完全削除
[fix] 音声認識エラーハンドリング修正
[docs] README更新
```

**コミット頻度**:
- 最低1日1コミット ✅
- 機能完成時は必ずコミット ✅
- 作業終了時は必ずプッシュ ✅

---

## 11. 成功指標（KPI）

### 11.1 技術的指標

- ✅ 全機能が正常に動作
- ✅ クラッシュ率: 1%未満
- ✅ APIエラー率: 5%未満
- ✅ 平均セッション時間: 5-10分
- ✅ セッション完了率: 70%以上

### 11.2 ポートフォリオ評価指標

- ✅ コードの可読性・保守性
- ✅ Git commitの適切さ
- ✅ ドキュメントの充実度
- ✅ デモのスムーズさ
- ✅ 実装した機能の網羅性
- ✅ セキュアなアーキテクチャ

---

## 12. 変更履歴

### v4.0 (2025年10月13日)
- ✅ ゲストモード完全廃止
- ✅ AI質問数を3問固定
- ✅ gpt-4o-miniに統一
- ✅ Cloud Functionsアーキテクチャ反映
- ✅ 音声文字起こし機能追加
- ✅ Day 1-8の実装経験反映
- ✅ 履歴機能のスコープ明確化

### v3.0 (2025年10月5日)
- 初版作成

---

**文書管理**:
- 作成者: プロジェクトオーナー
- 最終更新日: 2025年10月13日
- バージョン: 4.0（実装ベース改訂版）
- 次回レビュー: Week 2終了時（Day 14）